export function buildFamilyTreeWithSpouses(flat) {
  const byId = new Map();
  flat.forEach((n) =>
    byId.set(n.id, {
      id: n.id,
      ...n.data,
      children: [],
    })
  );

  // Find John (the person with multiple spouses)
  const root = flat.find((n) => n.rels?.spouses?.length > 1);

  const rootNode = byId.get(root.id);

  // Build each spouse node as a group
  const spouseNodes = root.rels.spouses.map((spouseId) => {
    const spouse = byId.get(spouseId);

    return {
      id: `spouse-${spouseId}`,
      type: "spouse",
      spouseId,
      firstName: spouse.firstName,
      lastName: spouse.lastName,
      birthday: spouse.birthday,
      gender: spouse.gender,
      children: [],
    };
  });

  // Attach children to their correct spouse-node
  flat.forEach((n) => {
    if (!n.rels?.parents) return;

    const child = byId.get(n.id);

    const fatherId = n.rels.parents.find((p) => byId.get(p).gender === "M");
    const motherId = n.rels.parents.find((p) => byId.get(p).gender === "F");

    if (fatherId === root.id && motherId) {
      // find spouse-group for the mother
      const group = spouseNodes.find((s) => s.spouseId === motherId);
      group.children.push(child);
    }
  });

  // Root has spouse groups as children
  rootNode.children = spouseNodes;

  return rootNode;
}
